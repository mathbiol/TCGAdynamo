<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>GSoC Mockup</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.3.min.js"></script>
        <script src="jquery-ui.min.js"></script>
        <script src="three.min.js"></script>
        <script type="text/javascript" src="patient_data.js"></script>
        <link href="jquery-ui.css" rel="stylesheet">
        
        <style>
            .ui-slider{
                width:50px;
                height:5px;
                margin-top:5px;
            }
            .ui-slider .ui-slider-handle{
                width: 5px;
                height: 15px;
                margin-left: -3px;
                outline: none;
            }
            .div{
                border: 2px solid #8AC007;
            }
            #slider label {
                position: absolute;
                margin-top: 12px;
                font-size:12px;
            }
            .ui-checkbox {
                font-size: 0.25em;
                margin: 0.6em;
            }
            
            input[type="number"] {
                width:50px;
            }
 
        </style>
        <script>
            
            
            function Model(){
                
                this.dots = [];
                this.distances = [];
                this.edges = [];
                this.node_degree = [];
                this.protein_weights = [];
                this.n_nearest_connect = 0;
                
                this.patient_data = JSON.parse(data);
                this.n_features = this.patient_data.patients[0].proteins.length;
                this.n_patients = this.patient_data.patients.length;
                
                console.log("n_patients: "+this.n_patients);
                console.log("n_features: "+this.n_features);
                
                for (var i=0;i<this.n_patients-1;i++){
                    this.distances[i]=0;
                    for (var k=i+1;k<this.n_patients;k++){
                        this.distances[i][k-i-1]=0;
                    }
                }
                
                for (var i=0;i<this.n_patients;i++){
                    this.edges[i] = [];
                    for (var k=0;k<this.n_patients;k++){
                        this.edges[i][k]=0;
                    }
                }
                
                for (var i=0;i<this.n_patients;i++){
                    this.node_degree[i]=0;
                }
                
                for (var i=0;i<this.n_features;i++){
                    this.protein_weights[i] = 0;
                }
                
                this.recompute = function(){
                    
                    
                    
                    var considered_proteins = [];
                    var protein_counter=0;
                    for (var i=0;i<this.n_features;i++){
                        if (this.protein_weights[i]!=0){
                            considered_proteins[protein_counter]=i;
                            protein_counter++;
                        }
                    }
                    
                    compute_euclidean_distance = function(a,b){
                        
                        var sum = 0;
                        for (var i=0;i<protein_counter;i++){
                            sum = sum+$model.protein_weights[considered_proteins[i]]*(Math.pow($model.patient_data.patients[a].proteins[considered_proteins[i]].value-$model.patient_data.patients[b].proteins[considered_proteins[i]].value,2));
                        }
                        sum=Math.sqrt(sum);
                        return(sum);
                    }
                    
                    for (var i=0;i<this.n_patients-1;i++){
                        this.distances[i] = [];
                        for (var k=i+1;k<this.n_patients;k++){
                            this.distances[i][k-i-1]=compute_euclidean_distance(i,k);
                        }
                    }
                    
                    find_nearest_neighbors = function(a){
                        
                       
                        var temp_counter=0;
                        var temp_distance=-1;
                        var temp_max_distance;
                        var temp_max_index;
                        var nearest_distances = [];
                        var nearest_indices = [];
                        for (var i=0;i<$model.n_patients;i++){
                            
                            if (i!=a){
                                
                                if (i<a){
                                    temp_distance = $model.distances[i][a-i-1];
                                }
                                else{
                                    temp_distance = $model.distances[a][i-a-1];
                                }
                                
                                if(temp_counter<$model.n_nearest_connect){
                                    nearest_distances[temp_counter]=temp_distance;
                                    nearest_indices[temp_counter]=i;
                                    temp_counter++;
                                }
                                else{
                                    temp_max_distance = nearest_distances[0];
                                    temp_max_index = 0;
                                    for (var k=1;k<$model.n_nearest_connect;k++){
                                        if (nearest_distances[k]>temp_max_distance){
                                            temp_max_distance = nearest_distances[k];
                                            temp_max_index=k;
                                        }
                                    }
                                    
                                    if (temp_distance<temp_max_distance){
                                        nearest_distances[temp_max_index]=temp_distance;
                                        nearest_indices[temp_max_index]=i;
                                    }
                                    
                                } 
                            }
                        } 
                        return(nearest_indices);
                    }
                    
                    for (var i=0;i<this.n_patients;i++){
                        this.node_degree[i]=0;
                        for (var k=0;k<this.n_patients;k++){
                            this.edges[i][k]=0;
                        }
                    }
                    
                    if (protein_counter>0){
                    for (var i=0;i<this.n_patients;i++){
                        neighbors = find_nearest_neighbors(i);
                        console.log(i+": "+neighbors);
                        for (var k=0;k<neighbors.length;k++){
                            if (neighbors[k]>i){
                                this.edges[i][neighbors[k]-i-1]=1;
                                this.node_degree[i]++;
                                this.node_degree[neighbors[k]]++;
                            }
                            else{
                                this.edges[neighbors[k]][i-neighbors[k]-1]=1;
                                this.node_degree[i]++;
                                this.node_degree[neighbors[k]]++;
                            }
                        }
                    }
                    }
                    for (var i=0;i<this.n_patients;i++){
                        console.log(i+": "+this.node_degree[i]);
                    }
                    
                    
                }
                
            }
            
            function Visualization() {
                
                this.scene = new THREE.Scene();
                this.width = 800;
                this.height = 650;
            
                this.canvas = document.createElement('canvas');
                document.getElementById('visualz').appendChild(this.canvas);
                document.body.appendChild(this.canvas);
            
                this.renderer = new THREE.WebGLRenderer({canvas: this.canvas,  antialiasing: true });
                this.renderer.setSize(this.width, this.height);
            
                this.camera_parameter=30;
                this.camera = new THREE.OrthographicCamera( this.width*this.camera_parameter / - 2, this.width*this.camera_parameter / 2, this.height*this.camera_parameter / 2, this.height*this.camera_parameter / - 2, - 500, 1000 );
                this.camera.position.x = 0;
                this.camera.position.y = 0;
                this.camera.position.z = 100;
                
                this.geometry = new THREE.SphereGeometry(200,0,0);
                
                for (var i=0;i<$model.n_patients;i++){
                    
                    this.material =new THREE.MeshBasicMaterial( { color: new THREE.Color( 0, 0.7, 0  ) } );
                    $model.dots[i] = new THREE.Mesh( this.geometry, this.material);
                    random_x = (Math.random() * this.camera_parameter*750) - this.camera_parameter*390;
                    random_y = (Math.random() * this.camera_parameter*580) - this.camera_parameter*280;
                  
                    $model.dots[i].position.x = random_x;
                    $model.dots[i].position.y = random_y;
                    this.scene.add($model.dots[i]);
                   
                }
                
                this.render = function(){
                    $controller.update();
                    
                    this.renderer.render( this.scene, this.camera );
                }
                
            }
            
            function Controller(){
                
                this.update = function(){
                    
                    var Fr = 0;
                    var Fa = 0;
                    var Fg = 0;
                    var distance = 0;
                    var kr = -800;
                    var kg = 0.008;
                    var Ftotal = 0;
                    var vector_between_x;
                    var vector_between_y;
                    var gravity_vector_x;
                    var gravity_vector_y;
                    var gravity_vector_length;
                    var velocity;
                    
                    for (var i=0;i<$model.n_patients;i++){
                        for (var k=i+1;k<$model.n_patients;k++){
                            distance = Math.sqrt(Math.pow(($model.dots[i].position.x-$model.dots[k].position.x),2)+Math.pow(($model.dots[i].position.y-$model.dots[k].position.y),2));
                            vector_between_x = $model.dots[i].position.x-$model.dots[k].position.x;
                            vector_between_y = $model.dots[i].position.y-$model.dots[k].position.y;
                            vector_between_x = vector_between_x/distance;
                            vector_between_y = vector_between_y/distance;
                            
                            //compute Fr as suggested in the paper
                            Fr = kr*(4/distance);
                            
                            //if the two patients are similar comptue Fa, else set Fa=0
                            if ($model.edges[i][k]==1){
                                Fa = Math.log((1+distance));
                            }
                            else{
                                Fa=0;
                            }
                            Ftotal = Fr + Fa;
                        
                            //set new positions
                            $model.dots[k].position.x=$model.dots[k].position.x+vector_between_x*Ftotal*0.8;
                            $model.dots[k].position.y=$model.dots[k].position.y+vector_between_y*Ftotal*0.8;
                
                            $model.dots[i].position.x=$model.dots[i].position.x-vector_between_x*Ftotal*0.8;
                            $model.dots[i].position.y=$model.dots[i].position.y-vector_between_y*Ftotal*0.8;
                       
                    }
                }
                //finally go over all nodes and compute the gravity
                for (var i=0;i<$model.n_patients;i++){
                    gravity_vector_x=-$model.dots[i].position.x;
                    gravity_vector_y=-$model.dots[i].position.y;
                    
                    gravity_vector_length=Math.sqrt(Math.pow(gravity_vector_x,2)+Math.pow(gravity_vector_y,2));
                    
                    
                    if ($model.n_nearest_connect>1)
                    Fg = (kg/Math.log($model.n_nearest_connect+1))*($model.node_degree[i]+1)*gravity_vector_length;
                    else{
                    Fg = (kg/1)*($model.node_degree[i]+1)*gravity_vector_length;
                    }
                    
                    gravity_vector_x=gravity_vector_x/gravity_vector_length;
                    gravity_vector_y=gravity_vector_y/gravity_vector_length;
                    $model.dots[i].position.x=$model.dots[i].position.x+gravity_vector_x*Fg*0.8;
                    $model.dots[i].position.y=$model.dots[i].position.y+gravity_vector_y*Fg*0.8;
                }
                
                
                }
                
                this.add_rppa_controls = function(){
                    
                    for (var i=0;i<$model.n_features;i++){
                
                        protein_div=document.createElement('div');
                        protein_div.setAttribute('style', "float:left; width:390px");
                        protein_div.setAttribute('id', "protein"+i);
                
                        checkbox_div=document.createElement('div');
                        checkbox_div.setAttribute('id',"checkbox_protein");
                        checkbox_div.setAttribute('style', "float:left; ");
                        checkbox_div.innerHTML=$model.patient_data.patients[0].proteins[i].ID;
                        checkbox_actual_wrapper = document.createElement('div');
                        checkbox_actual_wrapper.setAttribute('style', "float:left; position:relative");
                        checkbox_actual=document.createElement('input');
                
                        checkbox_handler = function(checkbox){
                            
                            if(checkbox.checked){
                                $('#slider'+checkbox.id).slider("value", 100);
                                $model.recompute();
                            }
                            else{
                                $('#slider'+checkbox.id).slider("value", 0); 
                                $model.recompute();
                            }
                            
                        }
                
                        checkbox_actual.setAttribute('onchange', "checkbox_handler(this)");
                        checkbox_actual.setAttribute('type',"checkbox");
                        checkbox_actual.setAttribute('id',i);
            
                        checkbox_actual.setAttribute('style',"position: absolute;left: 220px;");
                
                        $(checkbox_actual).appendTo(checkbox_actual_wrapper);
                        $(checkbox_actual_wrapper).appendTo(checkbox_div);
                
                        weight_div_wrapper = document.createElement('div');
                        weight_div_wrapper.setAttribute('style', "position:relative");
                        weight_div = document.createElement('div');
                        weight_div.setAttribute('style', "position:absolute; left: 260px;" );
                        weight_div.innerHTML="weight: ";
                
                        slider_div = document.createElement('div');
                        slider_div.setAttribute('id', "slider"+i);
                        slider_div.setAttribute('style', "position:absolut; left:320px");
                
                        $(checkbox_div).appendTo(protein_div);
                        $(weight_div).appendTo(weight_div_wrapper);
                        $(weight_div_wrapper).appendTo(protein_div);
                        $(slider_div).appendTo(protein_div);
                
                        controls = document.getElementById("controls1");
                        $(protein_div).appendTo(controls);
                
                        $( "#slider"+i ).slider({
                            change: function( event, ui ) {
                                var number = event.target.id.substring(6,(event.target.id.length));
                                
                                console.log(event.target.id+": "+ui.value);
                                $model.protein_weights[number] = ui.value/100;
                                $model.recompute();
                                
                            }
                        });
                    }
                }
            
                this.add_layout_controls = function(){
                    
                    n_nearest_div = document.createElement('div');
                    n_nearest_div.setAttribute('style', "margin-left:10px; width = 404px");
                    n_spinner = document.createElement('input');
                    n_spinner.setAttribute('id',"n_spinner");
                    n_spinner.setAttribute('type',"number");
                    n_spinner.setAttribute('style', "width=100px;");
                    
                    n_nearest_change = function(spinner){
                        $model.n_nearest_connect = spinner.value;
                        $model.recompute();
                    }
                    
                    n_spinner.setAttribute('onchange', "n_nearest_change(this)");
                    n_label = document.createElement('label');
                    n_label.setAttribute('for', 'n_spinner');
                    n_label.innerHTML="connect to nearest neighbors: ";
                
                    threshold_div = document.createElement('div');
                    threshold_div.setAttribute('style', "margin-left:10px;  width = 404px");
                
                    $(n_label).appendTo(n_nearest_div);
                    $(n_spinner).appendTo(n_nearest_div);
                    controls = document.getElementById("controls2");
                    $(n_nearest_div).appendTo(controls);
                    
                }
            
            }
            
            $(function(){
                
                $model = new Model();
                $visualization = new Visualization();
                $controller = new Controller();
                $controller.add_rppa_controls();
                $controller.add_layout_controls();
                
                setInterval(function(){ $visualization.render() }, 5);
                
            })
            
        </script>
    </head>
    <body>
        <div id="controls" style = "float: right">
        <div id="controls1" style="width:390px; overflow:scroll; height:300px; border: 2px solid #000000;padding-left: 14px; ">
            
        </div>
        <div id="controls2" style="margin-top:-2px; width:404px; height:100px; border:2px solid #000000; padding-top:10px">
           
        </div>
        </div>
        <div id="visualz" style ="float: left">
            
        </div>
        <script>
            
        </script>
    </body>
</html>
