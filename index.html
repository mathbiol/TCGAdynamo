<html>
    
<head>
    <title>Hello Web Workers</title>
    <script src="http://d3js.org/d3.v2.min.js?2.8.1"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="js/libs/jqueryui/css/base/jquery.ui.all.css">
    <script src="js/vendor/jquery-1.11.2.js"></script>
    <script src="js/libs/jqueryui/jquery-ui.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<body onresize="adjust_controls()">
    <div class="container-fluid" id="outer_container">
        
        <div class="row">
            <div class="col-md-2">
            <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" id="menu1" data-toggle="dropdown">Select Dataset
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="acc">acc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="blca">blca</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="brca">brca</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="cesc">cesc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="chol">chol</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="cntl">cntl</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="coad">coad</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="dlbc">dlbc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="esca">esca</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="fppp">fppp</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="gbm">gbm</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="hnsc">hnsc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="kich">kich</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="kirp">kirp</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="laml">laml</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lcml">lcml</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lgg">lgg</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lihc">lihc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lnnh">lnnh</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="luad">luad</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lusc">lusc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="meso">meso</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="ov">ov</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="paad">paad</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="pcpg">pcpg</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="prad">prad</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="read">read</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="sarc">sarc</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="skcm">skcm</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="stad">stad</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="tgct">tgct</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="thym">thym</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="ucec">ucec</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="ucs">ucs</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="uvm">uvm</a></li>
                <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="brca2">brca2</a></li>
            </ul>
            </div>
            </div>
        <div class="col-md-5" id="layout_button" style="display:none">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" id="menu2" data-toggle="dropdown">Layout
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                    <li role="presentation"><a class="layout_selection" role="menuitem" tabindex="-1" href="#" id="tsne">t-sne</a></li>
                    <li role="presentation"><a class="layout_selection" role="menuitem" tabindex="-1" href="#" id="force">force layout</a></li>
                </ul>
            </div>
        </div>
        </div>
        <div class="row " >
            <div class="col-md-7" id="visuals"></div>
            <div class="col-md-5 " id="parameter_controls">
                <div class="row" >
                    <div class="col-md-12" id="clinical_controls"></div>   
                </div>
                <div class="row">
                    <div class="col-md-12" id="rppa_controls"></div>   
                </div>
            </div>
        </div>
        
        <div class="row" id="table_container">
        </div>
        
        <div class="row">
            <div class="col-md-12" id="rppa_distribution">
                <!--<canvas id="rppa_plot"></canvas>
                <svg id="rppa_plot_axis"></svg>-->
                <div id="chart">
                    <canvas id="foreground"></canvas>
                    <svg></svg>
                </div>
            </div>
        </div>
        
        
    </div>
    <script>
        
        function adjust_controls(){
            var viewportHeight = window.innerHeight;      
            $("#parameter_controls").height(viewportHeight-10);
            $("#clinical_controls").height((viewportHeight/3)*2);
            $("#rppa_controls").height((viewportHeight/3));
        }
        
        function loadJSON(callback, which) {  
                    
                    var file_string = "json_data/"+which+"_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                        if (xobj.readyState == 4 && xobj.status == "200") {
                            callback(xobj.responseText);
                        }
                    };
                    xobj.send(); 
        }
        
        function build_group_tables(){
            
            var table_container = document.getElementById("table_container");
            $(table_container).empty();
            
            for (var i in selected_groups){
                console.log(i);
                var table_row = document.createElement("div");
                table_row.setAttribute("class", "row");
                $(table_row).appendTo(table_container);
                var table_header = document.createElement("h1");
                table_header.innerHTML = i.split("__")[0]+": "+i.split("__")[1];
                $(table_header).appendTo(table_row);
                
                var table_div = document.createElement("div");
                table_div.setAttribute("style", "overflow-x:scroll; overflow-y:scroll; max-height:400px");
                $(table_div).appendTo(table_row);
                table_div.innerHTML="<table class=\"table table-bordered\" id=\""+i+"_table\"></table>";
                
                var html_string="<thead><tr>";
                
                for (var k in $patients[0].clinical){
                    html_string+="<th class=\"text-center\">"+k+"</th>";
                }
                
                html_string+="</tr></thead><tbody id=\""+i+"_table_body\"><tr id=\""+i+"_table_row_1\"></tr></tbody>";
                
                $("#"+i+"_table").html(html_string);
                
                for (var k=0;k<selected_groups[i].length;k++){
                    html_string="";
                    for (var x in $patients[k].clinical){
                        html_string+="<td>"+$patients[k].clinical[x]+"</td>";
                    }
                    var number_rows = document.getElementById(i+"_table").rows.length;
                    $("#"+i+"_table_row_"+(number_rows-1)).html(html_string);
                    $("#"+i+"_table_body").append("<tr id=\""+i+"_table_row_"+(number_rows+1)+"\"></tr>");
                }
                
                //table_row.innerHTML="<table class=\"table table-bordered\" id=\""+i+"_table\"></table>";
                
            }
        }
        
        function draw_rppa_distribution(){
            
            var myWorker = new Worker('rppa_data_preprocessor.js');
            
            function draw_d3_plot(points, min, max){
                
                $("#rppa_distribution").empty();
                
                var w=50000;
                var h=1000;
                
                var number_proteins = $patients[0].RPPA.length;
                
                var xScale = d3.scale.linear()
                                .domain([-1, number_proteins+1])
                                .range([10, w]);
                            
                var yScale = d3.scale.linear()
                                .domain([min, max])
                                .range([h, 0]);
                        
                        
                var N = number_proteins;
                ticks=Array.apply(null, {length: N}).map(Number.call, Number)
                        
                var xAxis = d3.svg.axis()
                                .scale(xScale)
                                .tickValues(ticks)
                                .tickFormat(function(d){return $patients[0].RPPA[d].ID})
                                .ticks(number_proteins)
                                .orient("bottom");
                var yAxis = d3.svg.axis()
                                .scale(yScale)
                                .orient("left")
                                .ticks(20);
                        
                var svg = d3.select("#rppa_distribution").append("svg").attr("width",w).attr("height",h);
                
                colors = {1:"#6699FF", 2: "#00FF00", 3:"#CC6699", 4:"#FF3300", 5:"#66FFFF", 6:"#99FF99", 7:"#99FF99" };
                
                svg.selectAll("circle")
			.data(points)
			.enter()
			.append("circle")
			.attr("cx", function(d) {
			    return xScale(d[0]);
			})
			.attr("cy", function(d) {
			    return yScale(d[1]);
			})
			.attr("r", function(d) {
			    return 5;
			})
                        .style("fill", function(d){
                            return colors[d[2]];
                        });
                        
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 500 + ")")
                        .call(xAxis);
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 50 + ",0)")
                        .call(yAxis);
                
            }
            
            function draw_d3_plot2(points, min, max){
                
                $("#rppa_distribution").empty();
                
                var w=32767;
                var h=1000;
                
                var base = d3.select("#rppa_distribution");
                var chart = base.append("canvas")
                    .attr("width", 32767)
                    .attr("height", 1000);

                var context = chart.node().getContext("2d");
                
                var number_proteins = $patients[0].RPPA.length;

                var xScale = d3.scale.linear()
                    .domain([-1, number_proteins])
                    .range([10,32000]);
            
                var yScale = d3.scale.linear()
                    .domain([min, max])
                    .range([1000, 0]);

                points.forEach(function(d, i) {
                    context.beginPath();
                    context.arc(xScale(points[i][0]), yScale(points[i][1]), 5,0, 2*Math.PI);
                    context.fillStyle="red";
                    context.fill();
                    context.closePath();
                });
                
                
            }
            
            function draw_d3_plot4(points, min, max){
                
                $("#rppa_distribution").empty();
                $("#rppa_distribution").html("<div id=\"chart\"><canvas id=\"foreground\"></canvas><svg></svg></div>");
                
                var m = [30, 10, 10, 10],
                    w = 32767 - m[1] - m[3],
                    h = 1000 - m[0] - m[2];
            
                d3.selectAll("canvas")
                    .attr("width", w + m[1] + m[3])
                    .attr("height", h + m[0] + m[2])
                    .style("padding", m.join("px ") + "px");
                var svg = d3.select("svg")
                    .attr("width", w + m[1] + m[3])
                    .attr("height", h + m[0] + m[2])
                    .append("svg:g")
                    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
            
                var number_proteins = $patients[0].RPPA.length;
                
                var xScale = d3.scale.linear()
                                .domain([-1, number_proteins+1])
                                .range([10, w]);
                            
                var yScale = d3.scale.linear()
                                .domain([min, max])
                                .range([h, 0]);
                
                var N = number_proteins;
                ticks=Array.apply(null, {length: N}).map(Number.call, Number)
                        
                var xAxis = d3.svg.axis()
                                .scale(xScale)
                                .tickValues(ticks)
                                .tickFormat(function(d){return $patients[0].RPPA[d].ID})
                                .ticks(number_proteins)
                                .orient("bottom");
                var yAxis = d3.svg.axis()
                                .scale(yScale)
                                .orient("left")
                                .ticks(20);
                        
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 500 + ")")
                        .call(xAxis);
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 50 + ",0)")
                        .call(yAxis);
                var context = document.getElementById('foreground').getContext('2d');
                
                points.forEach(function(d, i) {
                    context.beginPath();
                    context.arc(xScale(points[i][0]), yScale(points[i][1]), 5,0, 2*Math.PI);
                    context.fillStyle="red";
                    context.fill();
                    context.closePath();
                });
                
            };
            
            myWorker.addEventListener("message", function (event) {
                //draw_d3_plot2(event.data["data"], event.data["min"], event.data["max"]);
                draw_d3_plot4(event.data["data"], event.data["min"], event.data["max"]);
                //draw_d3_plot4();
            }, false);
            
            myWorker.postMessage({"patients":$patients, "groups":selected_groups});
            
        }
        
        var selected_groups = {};
        function clinical_checkbox_clicked(checkbox){
            
            var selected_group = checkbox.id.substring(0,checkbox.id.length-9);
            var parameter = checkbox.id.split("__")[0];
            var value = checkbox.id.split("__")[1];
            var value = value.substring(0,value.length-9);
            console.log(parameter+" --> "+value+" clicked");
            
            var myWorker = new Worker('selected_group_finder.js');
            
            myWorker.addEventListener("message", function (event) {
                selected_groups[selected_group] = event.data;
                build_group_tables();
                draw_rppa_distribution();
                $(".parameter_checkbox").removeAttr("disabled");
            }, false);
            
            $(".parameter_checkbox").attr("disabled","true");
            myWorker.postMessage({"patients":$patients, "parameter":parameter, "value":value});
            
        }
        
        function add_clinical_controls(){
            
            $("#clinical_controls").empty();
            
            controls = document.getElementById("clinical_controls"); 
            
            for (var i in $patients[0].clinical){
                
                new_row = document.createElement('div');
                new_row.setAttribute('class',"row");
                $(new_row).appendTo(controls);
                
                column = document.createElement('div');
                column.setAttribute('class',"col-md-5");
                column.innerHTML=i;
                $(column).appendTo(new_row);
                
                column = document.createElement('div');
                column.setAttribute('class',"col-md-7 domain");
                
                var domain = {};
                for (var k=0;k<$patients.length;k++){
                   if ($patients[k].clinical[i] in domain){
                        domain[$patients[k].clinical[i]]=domain[$patients[k].clinical[i]]+1;
                    }
                    else{                        
                        domain[$patients[k].clinical[i]]=1;
                    }
                }
                
                for (var k in domain){
                    row = document.createElement('div');
                    row.setAttribute('class',"row");
                    
                    column2 = document.createElement('div');
                    column2.setAttribute('class',"col-md-8");
                    column2.innerHTML=k+": "+domain[k];
                    $(column2).appendTo(row);
                        
                    column3 = document.createElement('div');
                    column3.setAttribute('class',"col-md-2");
                    column3.innerHTML="<input class=\"parameter_checkbox\" type=\"checkbox\" onchange=\"clinical_checkbox_clicked(this)\" id=\""+i+"__"+k+"_checkbox\"/>";
                    $(column3).appendTo(row);
                    $(row).appendTo(column);
                }
                $(column).appendTo(new_row);
            }
            controls.setAttribute("style","border: 1px solid");
        }
        
        function add_rppa_controls(){
            
            controls = document.getElementById("rppa_controls");
            
            
            for (var i=0;i<$patients[0].RPPA.length;i++){
                        
                new_row = document.createElement('div');
                new_row.setAttribute('class',"row");
                $(new_row).appendTo(controls);
                    
                column = document.createElement('div');
                column.setAttribute('class',"col-md-5");
                column.innerHTML=$patients[0].RPPA[i].ID;
                $(column).appendTo(new_row);
                        
                column = document.createElement('div');
                column.setAttribute('class',"col-md-3");
                column.innerHTML="<input type=\"checkbox\" onchange=\"rppa_checkbox_clicked(this)\" id=\""+$patients[0].RPPA[i].ID+"_checkbox\"/>";
                $(column).appendTo(new_row);
                        
                column = document.createElement('div');
                column.setAttribute('class',"col-md-2");
                column.innerHTML="weight:";
                $(column).appendTo(new_row);
                        
                column = document.createElement('div');
                column.setAttribute('class',"col-md-2");
                column.innerHTML="<input type=\"range\" min=\"0\" max=\"1\" step=\"0.01\" value=\"0\" style=\"width:60px\" id=\""+$patients[0].RPPA[i].ID+"_slider\" onchange=\"rppa_weight_changed(this,0)\"/>"
                $(column).appendTo(new_row);
            }
            
            controls.setAttribute("style","border: 1px solid");
            
        }
        
        function draw_d3_plot3(){
            

var m = [30, 10, 10, 10],
    w = 960 - m[1] - m[3],
    h = 500 - m[0] - m[2];

var x = d3.scale.ordinal().rangePoints([0, w], 1),
    y = {};

var line = d3.svg.line(),
    axis = d3.svg.axis().orient("left"),
    background,
    foreground;

d3.selectAll("canvas")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
    .style("padding", m.join("px ") + "px");

foreground = document.getElementById('foreground').getContext('2d');
background = document.getElementById('background').getContext('2d');

foreground.strokeStyle = "rgba(0,100,160,0.24)";
background.strokeStyle = "rgba(0,0,0,0.02)";

var svg = d3.select("svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("svg:g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

d3.csv("cars.csv", function(cars) {

  // Extract the list of dimensions and create a scale for each.
  x.domain(dimensions = d3.keys(cars[0]).filter(function(d) {
    return d != "name" && (y[d] = d3.scale.linear()
        .domain(d3.extent(cars, function(p) { return +p[d]; }))
        .range([h, 0]));
  }));

  // Render full foreground and background
  cars.map(function(d) {
    path(d, background);
    path(d, foreground);
  });

  // Add a group element for each dimension.
  var g = svg.selectAll(".dimension")
      .data(dimensions)
    .enter().append("svg:g")
      .attr("class", "dimension")
      .attr("transform", function(d) { return "translate(" + x(d) + ")"; });

  // Add an axis and title.
  g.append("svg:g")
      .attr("class", "axis")
      .each(function(d) { d3.select(this).call(axis.scale(y[d])); })
    .append("svg:text")
      .attr("text-anchor", "middle")
      .attr("y", -9)
      .text(String);

  // Add and store a brush for each axis.
  g.append("svg:g")
      .attr("class", "brush")
      .each(function(d) { d3.select(this).call(y[d].brush = d3.svg.brush().y(y[d]).on("brush", brush)); })
    .selectAll("rect")
      .attr("x", -8)
      .attr("width", 16);

  // Handles a brush event, toggling the display of foreground lines.
  function brush() {
    var actives = dimensions.filter(function(p) { return !y[p].brush.empty(); }),
        extents = actives.map(function(p) { return y[p].brush.extent(); });

    // Get lines within extents
    var selected = [];
    cars.map(function(d) {
      return actives.every(function(p, i) {
        return extents[i][0] <= d[p] && d[p] <= extents[i][1];
      }) ? selected.push(d) : null;
    });

    // Render selected lines
    foreground.clearRect(0,0,w+1,h+1);
    selected.map(function(d) {
      path(d, foreground);
    });
  }
});

function path(d, ctx) {
  ctx.beginPath();
  dimensions.map(function(p,i) {
    if (i == 0) {
      ctx.moveTo(x(p),y[p](d[p]));
    } else { 
      ctx.lineTo(x(p),y[p](d[p]));
    }
  });
  ctx.stroke();
};
        }
        
        function draw_d3_plot4(){
            
            var m = [30, 10, 10, 10],
                    w = 32767 - m[1] - m[3],
                    h = 1000 - m[0] - m[2];
            
                d3.selectAll("canvas")
                    .attr("width", w + m[1] + m[3])
                    .attr("height", h + m[0] + m[2])
                    .style("padding", m.join("px ") + "px");
                var svg = d3.select("svg")
                    .attr("width", w + m[1] + m[3])
                    .attr("height", h + m[0] + m[2])
                    .append("svg:g")
                    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
            
                var number_proteins = $patients[0].RPPA.length;
                
                var xScale = d3.scale.linear()
                                .domain([-1, number_proteins+1])
                                .range([10, w]);
                            
                var yScale = d3.scale.linear()
                                .domain([min, max])
                                .range([h, 0]);
                
                var N = number_proteins;
                ticks=Array.apply(null, {length: N}).map(Number.call, Number)
                        
                var xAxis = d3.svg.axis()
                                .scale(xScale)
                                .tickValues(ticks)
                                .tickFormat(function(d){return $patients[0].RPPA[d].ID})
                                .ticks(number_proteins)
                                .orient("bottom");
                var yAxis = d3.svg.axis()
                                .scale(yScale)
                                .orient("left")
                                .ticks(20);
                        
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 500 + ")")
                        .call(xAxis);
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 50 + ",0)")
                        .call(yAxis);
                
                var context = document.getElementById('foreground').getContext('2d');
                
                points.forEach(function(d, i) {
                    context.beginPath();
                    context.arc(xScale(points[i][0]), yScale(points[i][1]), 5,0, 2*Math.PI);
                    context.fillStyle="red";
                    context.fill();
                    context.closePath();
                });
            
        }
        
        $(".dataset_selection").click(function(e){
            
            console.log(e.target.id+" selected");
            document.getElementById("layout_button").setAttribute("style","display:inline");
            loadJSON(function(response) {
                $patients = JSON.parse(response);
                
                add_clinical_controls();
                add_rppa_controls();
                adjust_controls();
            }, e.target.id);            
        });
        
    </script>
</body>
</html>

