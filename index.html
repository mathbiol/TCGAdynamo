<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <script type="text/javascript" src="tsne.js"></script>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <script src="http://d3js.org/d3.v2.min.js?2.8.1"></script>
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
        <script src="js/vendor/jquery-1.11.2.js"></script>
        <script src="js/vendor/three.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script>
            
            function Model(){
                
                this.patients;
                this.n_patients;
                this.n_features;
                this.distances = [];
                this.node_degree = [];
                this.edges = [];
                this.n_nearest_connect=2;
                this.tsne_selected=0;
                this.all_edges = [];
                this.protein_weights = [];
                
                this.pearson_correlations = [];
                this.spearman_correlations = [];
                
                this.compute_pearson_of_selected_patients = function(){
                    var selected = $controller.selected_patients;
                    mean_values = [];
                    $model.pearson_correlations = [];
                    compute_pearson_between_variables = function(param_a, param_b, selected){
                        
                        sum1=0;
                        sum2=0;
                        sum3=0;
                        for (var i=0;i<selected.length;i++){
                            sum1=sum1+((parseFloat($model.patients[selected[i]].RPPA[param_a].value)-this.mean_values[param_a])*(parseFloat($model.patients[selected[i]].RPPA[param_b].value)-this.mean_values[param_b]));
                            sum2=sum2+Math.pow((parseFloat($model.patients[selected[i]].RPPA[param_a].value)-this.mean_values[param_a]),2);
                            sum3=sum3+Math.pow((parseFloat($model.patients[selected[i]].RPPA[param_b].value)-this.mean_values[param_b]),2);
                        }
                        denominator = Math.sqrt(sum2*sum3);
                        correlation_coefficient = sum1/denominator;
                        
                        return(correlation_coefficient);
                        
                    }
                    
                    compute_mean_of_parameter = function(parameter, selected){
                        
                        sum=0;
                        
                        for (var i=0;i<selected.length;i++){
                            sum=sum+parseFloat($model.patients[selected[i]].RPPA[parameter].value);
                        }
                        
                        sum = sum/selected.length;
                        return(sum);
                    }
                    
                    for (var i=0;i<this.n_features;i++){
                        mean_values[i] = compute_mean_of_parameter(i, selected);
                    }
                    
                    for (var i=0;i<this.n_features-1;i++){
                        $model.pearson_correlations[i] = [];
                        for (var k=i+1;k<this.n_features;k++){
                            $model.pearson_correlations[i][k-i-1] = compute_pearson_between_variables(i,k,selected);
                        }
                    }
                
                }
                
                this.compute_spearman_of_selected_patients = function(){
                    
                    var selected = $controller.selected_patients;
                    $model.spearman_correlations = [];
                    
                    this.patient_feature_rank = [];
                    
                    for (var i=0;i<$model.n_patients;i++){
                        this.patient_feature_rank[i] = [];
                    }
                    
                    compare_values = function(a,b){
                        return a-b;
                    }
                    
                    temp_features = [];
                    var value_to_rank_map;
                    var temp_counter=1;
                    
                    for (var i=0;i<$model.n_features;i++){
                      
                        for (var k=0;k<selected.length;k++){
                            temp_features[k] = parseFloat($model.patients[selected[k]].RPPA[i].value);
                        }
                        temp_features.sort(compare_values);
                        
                        value_to_rank_map = {};
                        temp_counter=1;
                        value_to_rank_map[temp_features[0]]=1;
                        
                        for (var k=0;k<selected.length;k++){
                            if (temp_features[k]>temp_features[k-1]){
                                temp_counter++;
                                value_to_rank_map[temp_features[k]]=temp_counter;
                            }
                        }
                        
                        for (var k=0;k<selected.length;k++){
                            this.patient_feature_rank[k][i] = value_to_rank_map[parseFloat($model.patients[selected[k]].RPPA[i].value)];
                        }
                    }
                    
                    compute_spearman_between_parameters = function(param_a, param_b, selected, patient_feature_rank){
                        
                        var sum = 0;
                        
                        for (var i=0;i<selected.length;i++){
                            sum = sum+Math.pow((patient_feature_rank[i][param_a]-patient_feature_rank[i][param_b]),2);
                        }
                        
                        spearman_correlation = 1-((6*sum)/(selected.length*(Math.pow(selected.length,2)-1)));
                        
                        return(spearman_correlation);
                        
                    }
                    
                    for (var i=0;i<this.n_features-1;i++){
                        $model.spearman_correlations[i] = [];
                        for (var k=i+1;k<this.n_features;k++){
                            $model.spearman_correlations[i][k-i-1] = compute_spearman_between_parameters(i,k,selected, this.patient_feature_rank);
                            
                        }
                    }
                    
                }
                
                this.recompute = function(){
                    
                    var considered_proteins = [];
                    var protein_counter=0;
                    for (var i=0;i<this.n_features;i++){
                        if (this.protein_weights[i]!=0){
                            considered_proteins[protein_counter]=i;
                            protein_counter++;
                        }
                    }
                    
                    for (var i=0;i<this.n_patients;i++){
                        this.edges[i] = [];
                        for (var k=0;k<this.n_patients;k++){
                            this.edges[i][k]=0;
                        }
                    }
                    
                    compute_euclidean_distance = function(a,b){
                        
                        var sum = 0;
                        
                        for (var i=0;i<protein_counter;i++){
                            sum = sum+$model.protein_weights[considered_proteins[i]]*(Math.pow($model.patients[a].RPPA[i].value-$model.patients[b].RPPA[i].value,2));
                        }
                        
                        sum=Math.sqrt(sum);
                        return(sum);
                    }
                    
                    for (var i=0;i<this.n_patients-1;i++){
                        this.distances[i] = [];
                        for (var k=i+1;k<this.n_patients;k++){
                            this.distances[i][k-i-1]=compute_euclidean_distance(i,k);
                        }
                    }
                    
                    find_nearest_neighbors = function(a){
                        
                        var temp_counter=0;
                        var temp_distance=-1;
                        var temp_max_distance;
                        var temp_max_index;
                        var nearest_distances = [];
                        var nearest_indices = [];
                        for (var i=0;i<$model.n_patients;i++){
                            
                            if (i!=a){
                                
                                if (i<a){
                                    temp_distance = $model.distances[i][a-i-1];
                                }
                                else{
                                    temp_distance = $model.distances[a][i-a-1];
                                }
                                
                                
                                
                                if(temp_counter<$model.n_nearest_connect){
                                    nearest_distances[temp_counter]=temp_distance;
                                    nearest_indices[temp_counter]=i;
                                    temp_counter++;
                                }
                                else{
                                    temp_max_distance = nearest_distances[0];
                                    temp_max_index = 0;
                                    for (var k=1;k<$model.n_nearest_connect;k++){
                                        if (nearest_distances[k]>temp_max_distance){
                                            temp_max_distance = nearest_distances[k];
                                            temp_max_index=k;
                                        }
                                    }
                                    
                                    if (temp_distance<temp_max_distance){
                                        nearest_distances[temp_max_index]=temp_distance;
                                        nearest_indices[temp_max_index]=i;
                                    }
                                    
                                } 
                            }
                        } 
                        return(nearest_indices);
                    }
                    
                    for (var i=0;i<this.n_patients;i++){
                        this.node_degree[i]=0;
                        for (var k=0;k<this.n_patients;k++){
                            this.edges[i][k]=0;
                        }
                    }
                    
                    if (protein_counter>0){
                    var edge_counter=0;
                    for (var i=0;i<this.n_patients;i++){
                       
                        neighbors = find_nearest_neighbors(i);
                        
                        for (var k=0;k<neighbors.length;k++){
                            if (neighbors[k]>i){
                                this.edges[i][neighbors[k]-i-1]=1;
                                this.node_degree[i]++;
                                this.node_degree[neighbors[k]]++;
                                
                            }
                            else{
                                this.edges[neighbors[k]][i-neighbors[k]-1]=1;
                                this.node_degree[i]++;
                                this.node_degree[neighbors[k]]++;
                            }
                        }
                    }
                    }
                    
                }
            
                this.tsne = function(){
                    
                    console.log(document.getElementById("tsne_checkbox").checked);
                    if (document.getElementById("tsne_checkbox").checked==true){
                        $model.tsne_selected=1;
                        tsne_layout = new tsne(this.patients, $visualization.dots);
                    }
                    else{
                        $model.tsne_selected=0;
                    }
                    
                    
                }
                
                this.userstory_compute_fisher_ratios = function(){
                    
                    var values_group1 = [];
                    var values_group2 = [];
                    
                    for (var i=0;i<$model.n_features;i++){
                        values_group1[i] = [];
                        values_group2[i] = [];
                        for (var k=0;k<$model.n_patients;k++){
                            if ($model.patients[k].clinical["tobacco_smoking_pack_years_smoked"]=="[Not Available]"){
                                values_group1[i].push(parseFloat($model.patients[k].RPPA[i].value));
                            }
                            else{
                                values_group2[i].push(parseFloat($model.patients[k].RPPA[i].value));
                            }
                        }
                    }
                    
                    var mean_values_group1 = [];
                    var mean_values_group2 = [];
                    var sum=0;
                    for (var i=0;i<$model.n_features;i++){
                        for (var k=0;k<values_group1[i].length;k++){
                            sum = sum+values_group1[i][k];
                        }
                        sum = sum/values_group1[i].length;
                        mean_values_group1[i] = sum;
                        for (var k=0;k<values_group2[i].length;k++){
                            sum = sum+values_group2[i][k];
                        }
                        sum = sum/values_group1[i].length;
                        mean_values_group2[i] = sum;
                    }
                    
                    var variance_values_group1 = [];
                    var variance_values_group2 = [];
                    sum=0;
                    for (var i=0;i<$model.n_features;i++){
                        for (var k=0;k<values_group1[i].length;k++){
                            sum=sum+Math.pow(values_group1[i][k]-mean_values_group1[i],2);
                        }
                        sum=sum/values_group1[i].length;
                        variance_values_group1[i]=sum;
                        
                        for (var k=0;k<values_group2[i].length;k++){
                            sum=sum+Math.pow(values_group2[i][k]-mean_values_group2[i],2);
                        }
                        sum=sum/values_group2[i].length;
                        variance_values_group2[i]=sum;
                    }
                    
                    var fisher_ratios = [];
                    
                    for (var i=0;i<$model.n_features;i++){
                        fisher_ratios[i] = Math.pow(mean_values_group1[i]-mean_values_group2[i],2)/(variance_values_group1[i]+variance_values_group2[i]);
                    }
                   
                    
                    return (fisher_ratios);
                }
    
            }
            
            function Visualization(){
                
                this.scene = new THREE.Scene();
                this.width = 800;
                this.height = 650;
                this.canvas = document.createElement('canvas');
                document.getElementById('visuals').appendChild(this.canvas);
                this.renderer = new THREE.WebGLRenderer({canvas: this.canvas,  antialiasing: true });
                this.renderer.setSize(this.width, this.height);
                this.camera_parameter=30;
                this.camera = new THREE.OrthographicCamera( this.width*this.camera_parameter / - 2, this.width*this.camera_parameter / 2, this.height*this.camera_parameter / 2, this.height*this.camera_parameter / - 2, - 500, 1000 );
                this.camera.position.x = 0;
                this.camera.position.y = 0;
                this.camera.position.z = 100;
                
                this.dots=[];
                
                this.init_dots = function() {
                    
                    delete this.scene;
                    this.scene = new THREE.Scene();
                    
                    this.dots=[];
                    
                    this.geometry = new THREE.SphereGeometry(200,0,0);
                
                    for (var i=0;i<$model.n_patients;i++){
                    
                        this.material =new THREE.MeshBasicMaterial( { color: new THREE.Color( 0, 0.6, 0  ) } );
                    
                        // this.material =new THREE.MeshBasicMaterial( { color: new THREE.Color( 0, 0.7, 0  ) } );
                        this.dots[i] = new THREE.Mesh( this.geometry, this.material);
                        random_x = (Math.random() * this.camera_parameter*750/3) - this.camera_parameter*390/3;
                        random_y = (Math.random() * this.camera_parameter*580/3) - this.camera_parameter*280/3;
                  
                        this.dots[i].position.x = random_x;
                        this.dots[i].position.y = random_y;
                    
                        this.scene.add(this.dots[i]);
                    }
                }
                
                this.render = function(){
                    $controller.update();
                    this.renderer.render( this.scene, this.camera );
                }
                
                this.show_pearson_correlation=1;
                this.show_spearman_correlation=0;
                this.show_heatmap = function(){
                    
                    container = document.getElementById("parameter_visualization_buttons");
                    
                    container.innerHTML="<div id=\"param_visualization_buttons\" class=\"btn-toolbar btn-default\">";
                    container.innerHTML+="<button class=\"btn btn-default\" id=\"pearson_button\"><span>Pearson correlation</span></button>";
                    container.innerHTML+="<button class=\"btn btn-default\" id=\"spearman_button\"><span>Spearman correlation</span></button></div>";
                    
                    $('#pearson_button').on('click', function(e) {
                        $visualization.show_pearson_correlation=1;
                        $visualization.show_spearman_correlation=0;
                        $visualization.show_heatmap();
                    });
                        
                    $('#spearman_button').on('click', function(e) {
                        $visualization.show_pearson_correlation=0;
                        $visualization.show_spearman_correlation=1;
                        console.log("hi");
                        $visualization.show_heatmap();
                    });
                    
                    var margin = {top: 100, right: 20, bottom: 10, left: 100 },
                                width = 1500,
                                height = 1500;
                    
                    var x = d3.scale.ordinal().rangeBands([0, width]),
                        z = d3.scale.linear().domain([0, 4]).clamp(true),
                        c = d3.scale.category10().domain(d3.range(10));
                
                        
                    
                    $("#parameter_visualization").html("");
                    
                    var svg = d3.select("#parameter_visualization").append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                                .style("margin-left", +margin.left + "px")
                                .append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                        
                    var matrix = [];
                    
                    var counter=0;
                    
                    if ($visualization.show_pearson_correlation==1)
                    {
                    for (var i=0;i<$model.n_features;i++){
                        matrix[i] = [];
                        for (var k=0;k<$model.n_features;k++){
                            if (i!=k){
                                
                                if (k>i){
                                    if ($model.pearson_correlations[i][k-i-1]>0.9 || $model.pearson_correlations[i][k-i-1]<-0.9)
                                        matrix[i][k]={x:k,y:i,z:1};
                                    else
                                        matrix[i][k]={x:k,y:i,z:0};
                                }
                                else{
                                    if ($model.pearson_correlations[k][i-k-1]>0.9 || $model.pearson_correlations[k][i-k-1]<-0.9)
                                        matrix[i][k]={x:k,y:i,z:1};
                                    else
                                        matrix[i][k]={x:k,y:i,z:0};
                                }
                                
                            }
                            else{
                                matrix[i][k]={x:k,y:i,z:0};
                            }
                        }
                    }
                    }
                else{
                    for (var i=0;i<$model.n_features;i++){
                        matrix[i] = [];
                        for (var k=0;k<$model.n_features;k++){
                            if (i!=k){
                                
                                if (k>i){
                                    if ($model.spearman_correlations[i][k-i-1]>0.9 || $model.spearman_correlations[i][k-i-1]<-0.9)
                                        matrix[i][k]={x:k,y:i,z:1};
                                    else
                                        matrix[i][k]={x:k,y:i,z:0};
                                }
                                else{
                                    if ($model.spearman_correlations[k][i-k-1]>0.9 || $model.spearman_correlations[k][i-k-1]<-0.9)
                                        matrix[i][k]={x:k,y:i,z:1};
                                    else
                                        matrix[i][k]={x:k,y:i,z:0};
                                }
                                
                            }
                            else{
                                matrix[i][k]={x:k,y:i,z:0};
                            }
                        }
                    }
                    
                }
                    
                    x.domain(d3.range($model.n_features));
                    
                    svg.append("rect")
                        .attr("class", "background")
                        .attr("width", width)
                        .attr("height", height);
                
                    var row = svg.selectAll(".row")
                                .data(matrix)
                                .enter().append("g")
                                .attr("class", "row")
                                .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
                                .each(row);
                        
                    function row(row) {
                        var cell = d3.select(this).selectAll(".cell")
                        .data(row.filter(function(d) { return d.z; }))
                        .enter().append("rect")
                        .attr("class", "cell")
                        .attr("x", function(d) { return x(d.x); })
                        .attr("width", x.rangeBand())
                        .attr("height", x.rangeBand())
                        .style("fill-opacity", function(d) { return z(d.z); })
                        .style("fill", function(d) { return "red"; })
                        .on("mouseover", mouseover)
                        .on("mouseout", mouseout);
                    }
                    
                    function mouseover(p) {
                        d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
                        d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
                    }

                    function mouseout() {
                        d3.selectAll("text").classed("active", false);
                    }
                    
                    row.append("line")
                        .attr("x2", width);

                    row.append("text")
                        .attr("x", -6)
                        .attr("font-size","10px")
                        .attr("y", x.rangeBand() / 2)
                        .attr("dy", ".32em")
                        .attr("text-anchor", "end")
                        .text(function(d, i) { return $model.patients[0].RPPA[i].ID; });
                    
                    var column = svg.selectAll(".column")
                                .data(matrix)
                                .enter().append("g")
                                .attr("class", "column")
                                .attr("id", "column2")
                                .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
                    
                    column.append("line")
                        .attr("x1", -width);
                        
                    column.append("text")
                        .attr("x", 6)
                        .attr("font-size","10px")
                        .attr("y", x.rangeBand() / 2)
                        .attr("dy", ".32em")
                        .attr("text-anchor", "start")
                        .text(function(d, i) { return $model.patients[0].RPPA[i].ID; });

                }
                
                
                
            }
            
            function Controller(){
                
                this.update = function(){
                    
                    if ($model.tsne_selected==0){
                    
                    var max_x=0;
                    var max_y=0;
                    var Fr = 0;
                    var Fa = 0;
                    var Fg = 0;
                    var distance = 0;
                    var kr = -600;
                    var kg = 0.002;
                    var Ftotal = 0;
                    var vector_between_x;
                    var vector_between_y;
                    var gravity_vector_x;
                    var gravity_vector_y;
                    var gravity_vector_length;
                    var velocity;
                    
                    for (var i=0;i<$model.n_patients;i++){
                        for (var k=i+1;k<$model.n_patients;k++){
                            distance = Math.sqrt(Math.pow(($visualization.dots[i].position.x-$visualization.dots[k].position.x),2)+Math.pow(($visualization.dots[i].position.y-$visualization.dots[k].position.y),2));
                            vector_between_x = $visualization.dots[i].position.x-$visualization.dots[k].position.x;
                            vector_between_y = $visualization.dots[i].position.y-$visualization.dots[k].position.y;
                            vector_between_x = vector_between_x/distance;
                            vector_between_y = vector_between_y/distance;
                            
                            //compute Fr as suggested in the paper
                            Fr = kr*(4/distance);
                            
                            //if the two patients are similar comptue Fa, else set Fa=0
                            if ($model.edges[i][k-i-1]==1){
                                Fa = 1.5*Math.log((1+distance));
                            }
                            else{
                                Fa=0;
                            }
                            Ftotal = Fr + Fa;
                        
                            //set new positions
                            $visualization.dots[k].position.x=$visualization.dots[k].position.x+vector_between_x*Ftotal*0.8;
                            $visualization.dots[k].position.y=$visualization.dots[k].position.y+vector_between_y*Ftotal*0.8;
                
                            $visualization.dots[i].position.x=$visualization.dots[i].position.x-vector_between_x*Ftotal*0.8;
                            $visualization.dots[i].position.y=$visualization.dots[i].position.y-vector_between_y*Ftotal*0.8;
                       
                    }
                }
                //finally go over all nodes and compute the gravity
                for (var i=0;i<$model.n_patients;i++){
                    gravity_vector_x=-$visualization.dots[i].position.x;
                    gravity_vector_y=-$visualization.dots[i].position.y;
                    
                    gravity_vector_length=Math.sqrt(Math.pow(gravity_vector_x,2)+Math.pow(gravity_vector_y,2));
                    
                    
                    if ($model.n_nearest_connect>0)
                    Fg = (kg/Math.log($model.n_nearest_connect+1))*($model.node_degree[i]+1)*gravity_vector_length;
                    else{
                    Fg = (kg/1)*($model.node_degree[i]+1)*gravity_vector_length;
                    }
                    
                    gravity_vector_x=gravity_vector_x/gravity_vector_length;
                    gravity_vector_y=gravity_vector_y/gravity_vector_length;
                    $visualization.dots[i].position.x=$visualization.dots[i].position.x+gravity_vector_x*Fg*0.8;
                    $visualization.dots[i].position.y=$visualization.dots[i].position.y+gravity_vector_y*Fg*0.8;
                    
                    if (Math.abs($visualization.dots[i].position.x)>max_x){
                        max_index = i;
                        max_x=Math.abs($visualization.dots[i].position.x);
                    }
                    if (Math.abs($visualization.dots[i].position.y)>max_y){
                        max_y=Math.abs($visualization.dots[i].position.y);
                    }
                }
                }
                var max_x=0;
                var max_y=0;
                for (var i=0;i<$model.n_patients;i++){
                   
                    if (Math.abs($visualization.dots[i].position.x)>max_x){
                        max_index = i;
                        max_x=Math.abs($visualization.dots[i].position.x);
                    }
                    if (Math.abs($visualization.dots[i].position.y)>max_y){
                        max_y=Math.abs($visualization.dots[i].position.y);
                    }
                }
                
                //console.log("max: "+max_x+"; "+max_index);
                var new_cam_x;
                var new_cam_y;
                var new_cam=-1;
                
                new_cam_x=((max_x+400)/$visualization.width)*2;
                new_cam_y=((max_y+400)/$visualization.height)*2;
                
                if (new_cam_x>new_cam_y){
                    new_cam=new_cam_x;
                }
                else{
                    new_cam=new_cam_y;
                }
                
                if (new_cam!=$visualization.camera_parameter ){
                    $visualization.camera_parameter=new_cam;
                    $visualization.camera.top=new_cam*$visualization.height/2;
                    $visualization.camera.right=new_cam*$visualization.width/2;
                    $visualization.camera.left=new_cam*$visualization.width/-2;
                    $visualization.camera.bottom=new_cam*$visualization.height/-2;
                    $visualization.camera.updateProjectionMatrix();
                }   
                
                }
                
                this.rppa_checkbox_clicked = function(checkbox){
                    var rppa_id = checkbox.id.substring(0,checkbox.id.length-9)
                    console.log(rppa_id);
                    var slider_id = rppa_id+"_slider";
                    slider = document.getElementById(slider_id);
                    slider.value=1;
                    $controller.rppa_weight_changed(slider);
                }
                
                this.rppa_weight_changed = function(slider){
                    
                    console.log(slider.id+": "+slider.value+"; ");
                    var parameter = slider.id.substring(0,slider.id.length-7)
                    for (var i=0;i<$model.n_features;i++){
                        if ($model.patients[0].RPPA[i].ID==slider.id.substring(0,slider.id.length-7))
                            $model.protein_weights[i] = slider.value;
                    }
                    $model.recompute();
                }
                
                this.add_rppa_parameters = function(){
                    
                    document.getElementById("clinical_controls").innerHTML="";
                    document.getElementById("rppa_controls").innerHTML="";
                    
                    controls = document.getElementById("clinical_controls");
                    wrapper_row = document.createElement('div');
                    wrapper_row.setAttribute('class',"row");
                    
                    $(wrapper_row).appendTo(controls);
                    for (var i in $model.patients[0].clinical){
                        new_row = document.createElement('div');
                        new_row.setAttribute('class',"row");
                        $(new_row).appendTo(wrapper_row);
                    
                        column = document.createElement('div');
                        column.setAttribute('class',"col-md-8");
                        column.innerHTML=i;
                        $(column).appendTo(new_row);
                    }
                   
                    
                    controls = document.getElementById("rppa_controls");
                    
                    wrapper_row = document.createElement('div');
                    wrapper_row.setAttribute('class',"row");
                    
                    $(wrapper_row).appendTo(controls);
                    for (var i=0;i<$model.patients[0].RPPA.length;i++){
                        
                        new_row = document.createElement('div');
                        new_row.setAttribute('class',"row");
                        $(new_row).appendTo(wrapper_row);
                    
                        column = document.createElement('div');
                        column.setAttribute('class',"col-md-5");
                        column.innerHTML=$model.patients[0].RPPA[i].ID;
                        $(column).appendTo(new_row);
                        
                        
                        
                        column = document.createElement('div');
                        column.setAttribute('class',"col-md-1");
                        column.innerHTML="<input type=\"checkbox\" onchange=\"$controller.rppa_checkbox_clicked(this)\" id=\""+$model.patients[0].RPPA[i].ID+"_checkbox\"/>";
                        $(column).appendTo(new_row);
                        
                        column = document.createElement('div');
                        column.setAttribute('class',"col-md-2");
                        column.innerHTML="weight:";
                        $(column).appendTo(new_row);
                        
                        column = document.createElement('div');
                        column.setAttribute('class',"col-md-2");
                        column.innerHTML="<input type=\"range\" min=\"0\" max=\"1\" step=\"0.01\" value=\"0\" style=\"width:60px\" id=\""+$model.patients[0].RPPA[i].ID+"_slider\" onchange=\"$controller.rppa_weight_changed(this)\"/>"
                        $(column).appendTo(new_row);
                        
                        
                        
                    }
                    
                    
                    
                    
                }
                
                this.closest_old=-1;
                this.find_closest_dot = function(mouse_x,mouse_y){
                    
                    var distance = Number.POSITIVE_INFINITY;
                    var temp_distance;
                    var index;
                    
                    for (var i=0;i<$model.n_patients;i++){
                        temp_distance = Math.sqrt(Math.pow($visualization.dots[i].position.x-mouse_x,2)+Math.pow($visualization.dots[i].position.y-mouse_y,2));
                        if (temp_distance<distance){
                            distance = temp_distance;
                            index = i;
                        } 
                    }
                    
                    return(index);
                    
                }
                
                this.n_selected=0;
                this.selected_patients=[];
                this.rppa_details_selected=1;
                this.clinical_details_selected=0;
                this.list_rppa_details = function(){
                    
                    $controller.init_details_table();
                    
                    for (var k=0;k<$controller.selected_patients.length;k++){
                        
                        var index = $controller.selected_patients[k];
                        
                        tr = document.createElement("tr");
                        td = document.createElement("td");
                        td.innerHTML=$model.patients[index].clinical.bcr_patient_uuid;
                        $(td).appendTo(tr);
                    
                        for (var i=0;i<$model.n_features;i++){
                            td = document.createElement("td");
                            td.innerHTML=$model.patients[index].RPPA[i].value;
                            $(td).appendTo(tr);
                        }
                    
                        $(tr).appendTo(document.getElementById("table_body"));
                        
                    }
                    
                    
                    
                }
                
                this.list_clinical_details = function(){
                    
                    $controller.init_details_table();
                    
                    for (var k=0;k<$controller.selected_patients.length;k++){
                        
                        var index = $controller.selected_patients[k];
                        
                        tr = document.createElement("tr");
                        td = document.createElement("td");
                        td.innerHTML=$model.patients[index].clinical.bcr_patient_uuid;
                        $(td).appendTo(tr);
                    
                        for (var i in $model.patients[0].clinical){
                            td = document.createElement("td");
                            td.innerHTML=$model.patients[index].clinical[i];
                            $(td).appendTo(tr);
                        }
                    
                        $(tr).appendTo(document.getElementById("table_body"));
                        
                    }
                    
                }
                
                this.init_details_table = function(){
                    
                    container = document.getElementById("selected_patients");
                    
                    container.innerHTML="<div id=\"transform-buttons\" class=\"btn-toolbar btn-default\">";
                    container.innerHTML+="<button class=\"btn btn-default\" id=\"rppa_button\"><span>RPPA parameters</span></button>";
                    container.innerHTML+="<button class=\"btn btn-default\" id=\"clinical_button\"><span>Clinical data</span></button></div>";
                    container.innerHTML+="<table data-toggle=\"table\" data-cache=\"false\" data-height=\"299\" id=\"patient_table\">";
                    
                    $('#rppa_button').on('click', function(e) {
                            console.log("rppa button");
                            $controller.rppa_details_selected=1;
                            $controller.clinical_details_selected=0;
                            $controller.list_rppa_details();
                    });
                        
                    $('#clinical_button').on('click', function(e) {
                        console.log("clinical button");
                        $controller.clinical_details_selected=1;
                        $controller.rppa_details_selected=0;
                        $controller.list_clinical_details();
                    });
                    
                    table = document.getElementById("patient_table");
                    table.setAttribute("class","table");
                    thead = document.createElement("thead");
                    tr = document.createElement("tr");
                        
                    th = document.createElement("th");
                    th.innerHTML="patient_uuid";
                    $(th).appendTo(tr);
                    
                    if ($controller.rppa_details_selected==1){
                        for (var i=0;i<$model.n_features;i++){
                            th = document.createElement("th");
                            th.innerHTML=$model.patients[0].RPPA[i].ID;
                            $(th).appendTo(tr);
                        }
                    }
                    else{
                        for (var i in $model.patients[0].clinical){
                            th = document.createElement("th");
                            th.innerHTML=i;
                            $(th).appendTo(tr);
                        }
                    }
                        
                    tbody = document.createElement("tbody");
                    tbody.setAttribute("id","table_body");
                        
                    $(tr).appendTo(thead);
                    $(thead).appendTo(table);
                    $(tbody).appendTo(table);
                    $(table).appendTo(container);
                    
                }
                
                this.add_patient_to_details = function(index){
                  
                    
                    $controller.selected_patients[$controller.n_selected]=index;
                    $controller.n_selected++;
                    if ($controller.n_selected==1){
                        $controller.init_details_table();
                    }
                    
                    tr = document.createElement("tr");
                    
                    td = document.createElement("td");
                    td.innerHTML=$model.patients[index].clinical.bcr_patient_uuid;
                    $(td).appendTo(tr);
                    
                    for (var i=0;i<$model.n_features;i++){
                        td = document.createElement("td");
                        td.innerHTML=$model.patients[index].RPPA[i].value;
                        $(td).appendTo(tr);
                    }
                    
                    $(tr).appendTo(document.getElementById("table_body"));
                    
                }
                
                this.add_mouse_listener = function(){
                    
                    mousemove = function(event){
                        
                        var mouse_x = event.offsetX*$visualization.camera_parameter-(($visualization.width*$visualization.camera_parameter)/2);
                        var mouse_y = event.offsetY*$visualization.camera_parameter-(($visualization.height*$visualization.camera_parameter)/2);
                        mouse_y=mouse_y*-1;
                        
                        var closest = $controller.find_closest_dot(mouse_x, mouse_y);
                        
                        if ($controller.closest_old!=-1 && $controller.closest_old!=closest){
                            
                            $visualization.dots[closest].material.color.r = $visualization.dots[closest].material.color.r*2;
                            $visualization.dots[closest].material.color.g = $visualization.dots[closest].material.color.g*2;
                            $visualization.dots[closest].material.color.b = $visualization.dots[closest].material.color.b*2;
                            $visualization.dots[$controller.closest_old].material.color.r = $visualization.dots[$controller.closest_old].material.color.r/2;
                            $visualization.dots[$controller.closest_old].material.color.g = $visualization.dots[$controller.closest_old].material.color.g/2;
                            $visualization.dots[$controller.closest_old].material.color.b = $visualization.dots[$controller.closest_old].material.color.b/2;
                        }
                        
                        $controller.closest_old = closest;
                        
                    }
                    
                    mousedown = function(event){
                        
                        var mouse_x = event.offsetX*$visualization.camera_parameter-(($visualization.width*$visualization.camera_parameter)/2);
                        var mouse_y = (event.offsetY+72)*$visualization.camera_parameter-(($visualization.width*$visualization.camera_parameter)/2);
                        mouse_y=mouse_y*-1;
                       
                        closest = $controller.find_closest_dot(mouse_x, mouse_y);
                        
                        $controller.add_patient_to_details(closest);
                        
                        if ($controller.selected_patients.length>1){
                            $model.compute_pearson_of_selected_patients();
                            $model.compute_spearman_of_selected_patients();
                            $visualization.show_heatmap();
                        }
                    }
                    
                    $visualization.canvas.addEventListener('mousemove', mousemove, false);
                    $visualization.canvas.addEventListener('mousedown', mousedown, false);
                }
                
                function loadJSON(callback, which) {  
                    delete $visualization.scene;
                    var file_string = "json_data/"+which+"_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
                    };
                    xobj.send(); 
                }
                
                this.initialize_tables = function(){
                
                function loadJSON(callback) {  
                    var file_string = "json_data/lusc_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
                    };
                    xobj.send(); 
                }
                
                
               
                loadJSON(function(response) {
                       var data = JSON.parse(response);
                       $("#group1").css("background-color", "#6699FF");
                       $("#group1").html("<h1>Never smoker</h1><table class=\"table table-bordered\" id=\"table1\"></table>");
                       
                       
                       $("#group2").css("background-color", "#00FF00");
                       $("#group2").html("<h1>Current reformed smoker for > 15 years</h1><table class=\"table table-bordered\" id=\"table2\"></table>");
                       
                       $("#group3").css("background-color", "#CC6699");
                       $("#group3").html("<h1>Current reformed smoker for < or = 15 years</h1><table class=\"table table-bordered\" id=\"table3\"></table>");
                       $("#group4").css("background-color", "#FF3300");
                       $("#group4").html("<h1>Current smoker</h1><table class=\"table table-bordered\" id=\"table4\"></table>");
                       
                       this.init_tables = function(data){
                    
                    for (var i=1;i<5;i++){
                        
                        var html_string="<thead><tr>";
                        
                        for (var k in data[0].clinical){
                            html_string+="<th class=\"text-center\">"+k+"</th>";
                        }
                    
                        html_string+="</tr></thead><tbody id=\"group"+i+"_body\"><tr id=\"group"+i+"_row_1\"></tr></tbody>";
                        $("#table"+i).html(html_string);
                        
                    }
                }
                       this.fill_tables = function(data){
                   
                    this.init_tables(data);
                    
                    for (var i=0;i<data.length;i++){
                        if (data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for < or = 15 years"){
                            html_string="";
                            for (var k in data[i].clinical){
                                html_string+="<td>"+data[i].clinical[k]+"</td>";
                            }
                            var number_rows = document.getElementById("table3").rows.length;
                            
                            
                            $("#group3_row_"+(number_rows-1)).html(html_string);
                            $("#group3_body").append("<tr id=\"group3_row_"+(number_rows+1)+"\"></tr>");
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for > 15 years"){
                            html_string="";
                            for (var k in data[i].clinical){
                                html_string+="<td>"+data[i].clinical[k]+"</td>";
                            }
                            var number_rows = document.getElementById("table2").rows.length;
                            
                            
                            $("#group2_row_"+(number_rows-1)).html(html_string);
                            $("#group2_body").append("<tr id=\"group2_row_"+(number_rows+1)+"\"></tr>");
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Lifelong Non-smoker"){
                            html_string="";
                            for (var k in data[i].clinical){
                                html_string+="<td>"+data[i].clinical[k]+"</td>";
                            }
                            var number_rows = document.getElementById("table1").rows.length;
                            
                           
                            $("#group1_row_"+(number_rows-1)).html(html_string);
                            $("#group1_body").append("<tr id=\"group1_row_"+(number_rows+1)+"\"></tr>");
                            //console.log(i+": lifelong non");
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current smoker"){
                            html_string="";
                            for (var k in data[i].clinical){
                                html_string+="<td>"+data[i].clinical[k]+"</td>";
                            }
                            var number_rows = document.getElementById("table4").rows.length;
                            
                           
                            $("#group4_row_"+(number_rows-1)).html(html_string);
                            $("#group4_body").append("<tr id=\"group4_row_"+(number_rows+1)+"\"></tr>");
                        }
                        else{
                            //console.log(i+": "+data[i].clinical["tobacco_smoking_history_indicator"]);
                        }
                    }
                }
                       this.fill_tables(data);
                });
                
                
                
                
                
            }
                
                this.draw_rppa_distribution = function(){
                
                function loadJSON(callback) {  
                    var file_string = "json_data/lusc_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
                    };
                    xobj.send(); 
                }
                
                
                
                
               
                loadJSON(function(response) {
                       var data = JSON.parse(response);
                       
                this.find_min_max = function(data){
                    
                    var min=Number.POSITIVE_INFINITY;
                    var max=Number.NEGATIVE_INFINITY;
                    
                    for (var i=0;i<data.proteins.length;i++){
                        for (var k=0;k<data.proteins[i].groups.length;k++){
                            for (var x=0;x<data.proteins[i].groups[k].values.length;x++){
                                if (parseFloat(data.proteins[i].groups[k].values[x])<min){
                                    min=parseFloat(data.proteins[i].groups[k].values[x]);
                                }
                                if(parseFloat(data.proteins[i].groups[k].values[x])>max){
                                    max=parseFloat(data.proteins[i].groups[k].values[x]);
                                }
                            }
                        }
                    }
                    
                    return([min,max]);
                }
                
                       
                       this.merge_data = function(data){
                    
                    merged_data = [];
                    
                    for (var i=0;i<data.proteins.length;i++){
                        for (var k=0;k<data.proteins[i].groups.length;k++){
                            for (var x=0;x<data.proteins[i].groups[k].values.length;x++){
                                point = [i-0.22+k*0.16,data.proteins[i].groups[k].values[x],k];
                                merged_data.push(point);
                            }
                        }
                    }
                    
                    return merged_data;
                }
                       this.preprocess_data = function(data){
                    
                    var proteins = [];
                    for (var i=0;i<data[0].RPPA.length;i++){
                        proteins.push({"name":data[0].RPPA[i].ID, "groups":[{"values":[]},{"values":[]},{"values":[]},{"values":[]}]});
                    }
                    
                    for (var i=0;i<data.length;i++){
                        for (var k=0;k<data[i].RPPA.length;k++){
                            if (proteins[k].name==data[i].RPPA[k].ID){
                                if (data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for < or = 15 years"){
                                    proteins[k].groups[2].values.push(data[i].RPPA[k].value);
                                }
                                else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for > 15 years"){
                                    proteins[k].groups[1].values.push(data[i].RPPA[k].value);
                                }
                                else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Lifelong Non-smoker"){
                                    proteins[k].groups[0].values.push(data[i].RPPA[k].value);
                                }
                                else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current smoker"){
                                    proteins[k].groups[3].values.push(data[i].RPPA[k].value);
                                }
                                
                            }
                            else{
                                console.log("error");
                            }
                        }
                    }
                    
                    preprocessed_data = {"proteins":proteins};
                    
                    return(preprocessed_data);
                }
                       
                       this.test_drawing = function(data){
                    
                    test_data = {"proteins":[
                                            {"name":"protein 1", "groups":[{"values":[-10,2,3,4]},{"values":[2,6,4,7]},{"values":[4,5,6,7]},{"values":[1,2,3,4]}]},
                                            {"name":"protein 2", "groups":[{"values":[4,15,3,5]},{"values":[6,4,5,3]},{"values":[3,9,8,7]},{"values":[7,6,5,4]}]},
                                            {"name":"protein 3", "groups":[{"values":[1,9,9,1]},{"values":[9,3,4,6]},{"values":[2,5,4,3]},{"values":[4,4,4,3]}]},
                                            {"name":"protein 4", "groups":[{"values":[8,4,7,31]},{"values":[3,6,2,1]},{"values":[2,9,5,4]},{"values":[2,4,2,3]}]},
                                            {"name":"protein 5", "groups":[{"values":[6,3,2,6]},{"values":[7,7,6,7]},{"values":[9,8,7,6]},{"values":[2,3,2,21]}]},
                                            ]
                                };
                                
                    test_data = this.preprocess_data(data);
                                
                    min_max=this.find_min_max(test_data);
                    
                    merged_data = this.merge_data(test_data);
                    
                    var number_proteins = test_data.proteins.length;
                    
                    var w=50000;
                    var h=600;
                    
                    var xScale = d3.scale.linear()
                                    .domain([-1, number_proteins+1])
                                    .range([10, w]);
                            
                    var yScale = d3.scale.linear()
                                    .domain([min_max[0], min_max[1]])
                                    .range([h, 0]);
                            
                    var N = number_proteins; 
                    ticks=Array.apply(null, {length: N}).map(Number.call, Number)      
                    var xAxis = d3.svg.axis()
                                    .scale(xScale)
                                    .tickValues(ticks)
                                    .tickFormat(function(d){return test_data.proteins[d].name})
                                    .ticks(number_proteins)
                                    .orient("bottom");
                    var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(5);
                    
                    var svg = d3.select("#rppa_distribution").append("svg").attr("width",w).attr("height",h);
                    
                    svg.selectAll("circle")
			   .data(merged_data)
			   .enter()
			   .append("circle")
			   .attr("cx", function(d) {
			   		return xScale(d[0]);
			   })
			   .attr("cy", function(d) {
			   		return yScale(d[1]);
			   })
			   .attr("r", function(d) {
			   		return 5;
			   })
                           .style("fill", function(d){
                               if (d[2]==0){
                                   return "#6699FF";
                               }
                               else if (d[2]==1){
                                   return "#00FF00";
                               }
                               else if (d[2]==2){
                                   return "#CC6699";
                               }
                               else{
                                   return "#FF3300";
                               }
                               
                           });
                    
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + (360) + ")")
                        .call(xAxis);
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 50 + ",0)")
                        .call(yAxis);
                             
                }
                       this.test_drawing(data);
                });
                
            }
                
                this.test_gender_distribution = function(){
                
                
                
                function loadJSON(callback) {  
                    var file_string = "json_data/lusc_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
                    };
                    xobj.send(); 
                }
                
                loadJSON(function(response) {
                       var data = JSON.parse(response);
                       
                       this.preprocess_data_2 = function(data){
                    
                    var group1_male=0;
                    var group1_female=0;
                    var group2_male=0;
                    var group2_female=0;
                    var group3_male=0;
                    var group3_female=0;
                    var group4_male=0;
                    var group4_female=0;
                    
                    for (var i=0;i<data.length;i++){
                        if (data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for < or = 15 years"){
                            if (data[i].clinical["gender"]=="MALE"){
                                group3_male++;
                            }
                            else if (data[i].clinical["gender"]=="FEMALE"){
                                group3_female++;
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for > 15 years"){
                            if (data[i].clinical["gender"]=="MALE"){
                                group2_male++;
                            }
                            else if (data[i].clinical["gender"]=="FEMALE"){
                                group2_female++;
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Lifelong Non-smoker"){
                            if (data[i].clinical["gender"]=="MALE"){
                                group1_male++;
                            }
                            else if (data[i].clinical["gender"]=="FEMALE"){
                                group1_female++;
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current smoker"){
                            if (data[i].clinical["gender"]=="MALE"){
                                group4_male++;
                            }
                            else if (data[i].clinical["gender"]=="FEMALE"){
                                group4_female++;
                            }
                        }
                    }
                    
                    return[group1_female,group1_male,group2_female,group2_male,group3_female,group3_male,group4_female,group4_male];
                }
                
                this.draw_histogram = function(data){
                 
                test_data = this.preprocess_data_2(data);
                
                var w = 320;
                var h = 380;
                
                var xScale = d3.scale.linear()
                                    .domain([-1, 11])
                                    .range([20, 315]);
                            
                            
                var yScale = d3.scale.linear()
                                    .domain([0, d3.max(test_data)+10])
                                    .range([340, 0]);
                
                var xAxis = d3.svg.axis()
                                    .scale(xScale)
                                    .tickValues([0,1,3,4,6,7,9,10])
                                    .tickFormat(function(d){if (d==1 || d==4 || d==7 || d==10) return "M"; else return "F";})
                                    .orient("bottom"); 
                var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(5);            
        
                var svg = d3.select("#male_female_distribution").append("svg").attr("width",w).attr("height",h).append("g").attr("transform", "translate(" +10 + "," + 20 + ")");
                
                svg.selectAll("rect")
                        .data(test_data)
                        .enter()
                        .append("rect")
                        .attr("x", function(d,i){   if (i>5)
                                                        return xScale(i+3)-((315-20)/12)/2;
                                                    if (i>3)
                                                        return xScale(i+2)-((315-20)/12)/2;
                                                    if (i>1) 
                                                        return xScale(i+1)-((315-20)/12)/2; 
                                                    else 
                                                        return xScale(i)-((315-20)/12)/2;
                                                })
                        .attr("y", function(d,i){return yScale(d);})
                        .attr("width",(315-20)/12)
                        .attr("height", function (d,i){return (340)-yScale(d);})
                        .style("fill", function(d,i){
                                            if (i>5)
                                                        return "#FF3300";
                                            if (i>3)
                                                        return "#CC6699";
                                            if (i>1) 
                                                        return "#00FF00"; 
                                            else 
                                                        return "#6699FF";
                                                });
                
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 338 + ")")
                        .call(xAxis);
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 28 + ",0)")
                        .call(yAxis);
                }
                       this.draw_histogram(data);
                });
            }
                
                this.test_age_distribution = function(){
                
                function loadJSON(callback) {  
                    var file_string = "json_data/lusc_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
                    };
                    xobj.send(); 
                }
                
                
                
                loadJSON(function(response) {
                       var data = JSON.parse(response);
                       this.merge_data_2 = function(data){
                    
                    merged_data = [];
                    for (var i=0;i<data.length;i++){
                        if (data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for < or = 15 years"){
                            if (data[i].clinical["age_at_initial_pathologic_diagnosis"]!="[Not Available]"){
                                point=[2,parseInt(data[i].clinical["age_at_initial_pathologic_diagnosis"]),2];
                                merged_data.push(point);
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for > 15 years"){
                            if (data[i].clinical["age_at_initial_pathologic_diagnosis"]!="[Not Available]"){
                                point=[1,parseInt(data[i].clinical["age_at_initial_pathologic_diagnosis"]),1];
                                merged_data.push(point); 
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Lifelong Non-smoker"){
                            if (data[i].clinical["age_at_initial_pathologic_diagnosis"]!="[Not Available]"){
                                point=[0,parseInt(data[i].clinical["age_at_initial_pathologic_diagnosis"]),0];
                                merged_data.push(point);
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current smoker"){
                            if (data[i].clinical["age_at_initial_pathologic_diagnosis"]!="[Not Available]"){
                                point=[3,parseInt(data[i].clinical["age_at_initial_pathologic_diagnosis"]),3];
                                merged_data.push(point);
                            }
                        }
                    }
                    
                    return (merged_data);
                }
                
                this.draw_age_distribution = function(data){
                    
                    var w = 620;
                    var h = 380;
                    
                    merged_data = this.merge_data_2(data);
                    
                    var xScale = d3.scale.linear()
                                    .domain([-1, 4])
                                    .range([10, w]);
                            
                    var yScale = d3.scale.linear()
                                    .domain([0, 100])
                                    .range([365, 10]);        
                            
                    var xAxis = d3.svg.axis()
                                    .scale(xScale)
                                    .tickValues([0,1,2,3])
                                    .tickFormat(function(d){ if (d==0) return "Never smokers"; if (d==1) return "Reformed > 15yrs"; if (d==2) return "Reformed < 15yrs"; return "Current smokers"  })
                                    .orient("bottom");
                    
                    var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(5);                 
        
                    var svg = d3.select("#age_distribution").append("svg").attr("width",w).attr("height",h).attr("transform", "translate(" +10 + "," + 50 + ")");
                    
                    svg.selectAll("circle")
			   .data(merged_data)
			   .enter()
			   .append("circle")
			   .attr("cx", function(d) {
			   		return xScale(d[0]);
			   })
			   .attr("cy", function(d) {
			   		return yScale(d[1]);
			   })
			   .attr("r", function(d) {
			   		return 5;
			   })
                           .style("fill",function(d,i){
                               if (d[2]==3)
                                    return "#FF3300";
                               if (d[2]==2)
                                   return "#CC6699";
                               if (d[2]==1)
                                   return "#00FF00";
                                   return "#6699FF";
                           });
                    
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(10," + 360 + ")")
                        .call(xAxis);
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 30 + ",0)")
                        .call(yAxis);
                };
                       this.draw_age_distribution(data);
                });
            }
                
                this.test_tumor_type_distribution = function(){
                
                function loadJSON(callback) {  
                    var file_string = "json_data/lusc_data.json";
                    console.log("loading "+file_string);
                    var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
                    xobj.open('GET', file_string, true);
                    xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
                    };
                    xobj.send(); 
                }
                
                
                
                loadJSON(function(response) {
                       var data = JSON.parse(response);
                       
                       
                       this.preprocess_data_3 = function(data){
                    
                    var group1_type1=0;
                    var group1_type2=0;
                    var group1_type3=0;
                    var group1_type4=0;
                    var group1_type5=0;
                    var group1_type6=0;
                    
                    var group2_type1=0;
                    var group2_type2=0;
                    var group2_type3=0;
                    var group2_type4=0;
                    var group2_type5=0;
                    var group2_type6=0;
                    
                    var group3_type1=0;
                    var group3_type2=0;
                    var group3_type3=0;
                    var group3_type4=0;
                    var group3_type5=0;
                    var group3_type6=0;
                    
                    var group4_type1=0;
                    var group4_type2=0;
                    var group4_type3=0;
                    var group4_type4=0;
                    var group4_type5=0;
                    var group4_type6=0;
                    
                    for (var i=0;i<data.length;i++){
                        if (data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for < or = 15 years"){
                            if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IA"){
                                group3_type1++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IB"){
                                group3_type2++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIA"){
                                group3_type3++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIB"){
                                group3_type4++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIA"){
                                group3_type5++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIB"){
                                group3_type6++;
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for > 15 years"){
                            if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IA"){
                                group2_type1++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IB"){
                                group2_type2++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIA"){
                                group2_type3++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIB"){
                                group2_type4++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIA"){
                                group2_type5++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIB"){
                                group2_type6++;
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Lifelong Non-smoker"){
                            if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IA"){
                                group1_type1++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IB"){
                                group1_type2++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIA"){
                                group1_type3++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIB"){
                                group1_type4++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIA"){
                                group1_type5++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIB"){
                                group1_type6++;
                            }
                        }
                        else if(data[i].clinical["tobacco_smoking_history_indicator"]=="Current smoker"){
                            if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IA"){
                                group4_type1++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IB"){
                                group4_type2++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIA"){
                                group4_type3++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIB"){
                                group4_type4++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIA"){
                                group4_type5++;
                            }
                            else if (data[i].clinical["ajcc_pathologic_tumor_stage"]=="Stage IIIB"){
                                group4_type6++;
                            }
                        }
                    }
                    
                    return [group1_type1,group1_type2,group1_type3,group1_type4,group1_type5,group1_type6, group2_type1,group2_type2,group2_type3,group2_type4,group2_type5,group2_type6, group3_type1,group3_type2,group3_type3,group3_type4,group3_type5, group3_type6,group4_type1,group4_type2,group4_type3,group4_type4, group4_type5, group4_type6];
                    
                }
                
                this.test_draw_tumor_type = function(data){
                    
                    var w = 2000;
                    var h = 380;
                    
                    //var test_data = [10,20,10,40,50,20, 30,40,40,30,20,10, 10,10,90,80,10,30, 30,40,70,50,90,60];
                    
                    var test_data = this.preprocess_data_3(data);
                    
                    var xScale = d3.scale.linear()
                                    .domain([-1, 28])
                                    .range([10, w]);
                    
                    var xAxis = d3.svg.axis()
                                    .scale(xScale)
                                    .tickValues([0,1,2,3,4,5, 7,8,9,10,11,12, 14,15,16,17,18,19, 21,22,23,24,25,26])
                                    .tickFormat(function(d){ if (d==0 || d==7 || d==14 || d==21) return "Stage IA"; if (d==1 || d==8 || d==15 || d==22) return "Stage IB"; if (d==2 || d==9 || d==16 || d==23) return "Stage IIA"; if (d==3 || d==10 || d==17 || d==24) return "Stage IIB"; if (d==4 || d==11 || d==18 || d==25) return "Stage IIIA"; if (d==5 || d==12 || d==19 || d==26) return "Stage IIIB";})
                                    .orient("bottom");
                    
                    var yScale = d3.scale.linear()
                                    .domain([0, d3.max(test_data)+10])
                                    .range([365, 10]);
                            
                    var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(5);  
                            
                    var svg = d3.select("#tumor_type_distribution").append("svg").attr("width",w).attr("height",h).attr("transform", "translate(" +10 + "," + 50 + ")");
                    
                    svg.selectAll("rect")
                        .data(test_data)
                        .enter()
                        .append("rect")
                        .attr("x", function(d,i){  if (i>17)
                                                        return xScale(i+3)-((315-20)/28)/2;
                                                   if (i>11)
                                                        return xScale(i+2)-((315-20)/28)/2;
                                                   if (i>5)
                                                        return xScale(i+1)-((315-20)/28)/2;
                                                    return xScale(i)-((315-20)/28)/2;;
                                                })
                        .attr("y", function(d,i){return yScale(d);})
                        .attr("width",(315-20)/12)
                        .attr("height", function (d,i){return (360)-yScale(d);})
                        .style("fill", function (d,i) {
                            
                            if (i>17)
                                return "#FF3300";
                            if (i>11)
                                return "#CC6699";
                            if (i>5)
                                return  "#00FF00";
                            return "#6699FF";
                        });
                    
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(10," + 360 + ")")
                        .call(xAxis);
                
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 30 + ",0)")
                        .call(yAxis);
                    
                }
                       
                       this.test_draw_tumor_type(data);
                });
                
            }
            
                
                $(".dataset_selection").click(function(e){
                    
                    
                    $model.tsne_selected=0;
                    $controller.closest_old=-1;
                    var checkbox = document.getElementById("tsne_checkbox");
                    checkbox.checked=false;
                    console.log(e.target.id+" selected");
                    selected_data_set=e.target.id;
                    
                    loadJSON(function(response) {
                        $model.patients = JSON.parse(response);
                        $model.n_features = $model.patients[0].RPPA.length;
                        $model.n_patients = $model.patients.length;
                        for (var i=0;i<$model.n_features;i++){
                            $model.protein_weights[i]=0;
                        }
                        $model.recompute();
                        $visualization.init_dots();
                        console.log($model.patients.length);
                        console.log($model.n_features);
                        $controller.add_rppa_parameters();
                        
                        if ($controller.userstory_selected==1){
                            //$controller.userstory_lusc_select_patients();
                            $controller.userstory_color_dots();
                        }
                        else if ($controller.userstory_selected==2){
                            $controller.userstory_2_color_dots();
                            $model.n_nearest_connect=5;
                        }
                        
                    }, e.target.id);
                });
                
                $(".userstory_selection").click(function(e){
                   console.log(e.target.id); 
                   if (e.target.id=="userstory_lcsc"){
                       $controller.userstory_selected=1;
                        button = document.getElementById("lusc");
                        var event = button["click"];
                        event.call(button);
                        $controller.initialize_tables();
                        $controller.draw_rppa_distribution();
                        $controller.test_gender_distribution();
                        $controller.test_age_distribution();
                        $controller.test_tumor_type_distribution();
                        
                   }
                   else if (e.target.id=="userstory_brca"){
                       $controller.userstory_selected=2;
                       button = document.getElementById("brca2");
                       var event = button["click"];
                       event.call(button);
                       
                   }
                   
                });
                
                this.userstory_add_patients_to_details = function(){
                    
                    for (var i=0;i<$model.n_patients;i++){
                        if ($model.patients[i].clinical["tobacco_smoking_pack_years_smoked"]=="[Not Available]"){
                            
                            tr = document.createElement("tr");
                            td = document.createElement("td");
                            td.innerHTML=$model.patients[i].clinical.bcr_patient_uuid;
                            $(td).appendTo(tr);
                            
                            if ($controller.rppa_details_selected==1){
                                for (var k=0;k<$model.n_features;k++){
                                    td = document.createElement("td");
                                    td.innerHTML=$model.patients[i].RPPA[k].value;
                                    $(td).appendTo(tr);
                                }
                            }
                            else{
                                for (var k in $model.patients[0].clinical){
                                    td = document.createElement("td");
                                    td.innerHTML=$model.patients[i].clinical[k];
                                    $(td).appendTo(tr);
                                }
                            }
                            
                            $(tr).appendTo(document.getElementById("group1"));
                        }   
                        else{
                            
                            tr = document.createElement("tr");
                            td = document.createElement("td");
                            td.innerHTML=$model.patients[i].clinical.bcr_patient_uuid;
                            $(td).appendTo(tr);
                            if ($controller.rppa_details_selected==1){
                                for (var k=0;k<$model.n_features;k++){
                                    td = document.createElement("td");
                                    td.innerHTML=$model.patients[i].RPPA[k].value;
                                    $(td).appendTo(tr);
                                }
                            }
                            else{
                                for (var k in $model.patients[0].clinical){
                                    td = document.createElement("td");
                                    td.innerHTML=$model.patients[i].clinical[k];
                                    $(td).appendTo(tr);
                                }
                            }
                            
                            $(tr).appendTo(document.getElementById("group2"));
                        }
                            
                    }
                    
                }
                
                this.userstory_color_dots = function(){
                    
                        for (var i=0;i<$model.n_patients;i++){
                            if ($model.patients[i].clinical["tobacco_smoking_history_indicator"]=="Lifelong Non-smoker"){
                                $visualization.dots[i].material.color = new THREE.Color( 0x6699FF);
                            }
                            else if($model.patients[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for > 15 years"){
                                $visualization.dots[i].material.color = new THREE.Color( 0x00FF00 );
                            }
                            else if ($model.patients[i].clinical["tobacco_smoking_history_indicator"]=="Current reformed smoker for < or = 15 years"){
                                $visualization.dots[i].material.color = new THREE.Color( 0xCC6699 );
                            }
                            else if ($model.patients[i].clinical["tobacco_smoking_history_indicator"]=="Current smoker"){
                                $visualization.dots[i].material.color = new THREE.Color( 0xFF3300 );
                            }
                        }
                }
   
                this.userstory_selected=0;
                this.userstory_lusc_select_patients = function(){
                    
                    column = document.getElementById("selected_patients");
                    column.innerHTML="<div class=\"row\"> <div class=\"col-md-12\" id=\"userstory_lusc_buttons\">";
                    column.innerHTML+="<div id=\"transform-buttons\" class=\"btn-toolbar btn-default\">";
                    column.innerHTML+="<button class=\"btn btn-default\" id=\"rppa_button\"><span>RPPA parameters</span></button>";
                    column.innerHTML+="<button class=\"btn btn-default\" id=\"clinical_button\"><span>Clinical data</span></button></div>";
                    column.innerHTML+="</div></div>";
                    column.innerHTML+="<div class=\"row\"><div class=\"col-md-6\" id=\"group1\">group1</div><div class=\"col-md-6\" id=\"group2\">group2</div></div>";
                    
                    $('#rppa_button').on('click', function(e) {
                            console.log("rppa button");
                            $controller.rppa_details_selected=1;
                            $controller.clinical_details_selected=0;
                            $controller.userstory_lusc_select_patients();
                    });
                        
                    $('#clinical_button').on('click', function(e) {
                        console.log("clinical button");
                        $controller.clinical_details_selected=1;
                        $controller.rppa_details_selected=0;
                        $controller.userstory_lusc_select_patients();
                    });
                    
                    group1_column = document.getElementById("group1");
                    
                    group1.innerHTML="<table data-toggle=\"table\" data-cache=\"false\" data-height=\"299\" id=\"group1_table\">";
                    
                    group2_column = document.getElementById("group2");
                    
                    group2.innerHTML="<table data-toggle=\"table\" data-cache=\"false\" data-height=\"299\" id=\"group2_table\">";
                    
                    table = document.getElementById("group1_table");
                    table.setAttribute("class","table");
                    thead = document.createElement("thead");
                    tr = document.createElement("tr");
                    th = document.createElement("th");
                    th.innerHTML="patient_uuid";
                    $(th).appendTo(tr);
                    if ($controller.rppa_details_selected==1){
                        
                        for (var i=0;i<$model.n_features;i++){
                            th = document.createElement("th");
                            th.innerHTML=$model.patients[0].RPPA[i].ID;
                            $(th).appendTo(tr);
                        }
                    }
                    else{
                        for (var i in $model.patients[0].clinical){
                            th = document.createElement("th");
                            th.innerHTML=i;
                            $(th).appendTo(tr);
                        }
                    }
                    
                    $(tr).appendTo(thead);
                    $(thead).appendTo(table);
                    
                    
                    table = document.getElementById("group2_table");
                    table.setAttribute("class","table");
                    thead = document.createElement("thead");
                    tr = document.createElement("tr");
                    th = document.createElement("th");
                    th.innerHTML="patient_uuid";
                    $(th).appendTo(tr);
                    if ($controller.rppa_details_selected==1){
                        for (var i=0;i<$model.n_features;i++){
                            th = document.createElement("th");
                            th.innerHTML=$model.patients[0].RPPA[i].ID;
                            $(th).appendTo(tr);
                        }
                    }
                    else{
                        for (var i in $model.patients[0].clinical){
                            th = document.createElement("th");
                            th.innerHTML=i;
                            $(th).appendTo(tr);
                        }
                    }
                    
                    $(th).appendTo(tr);
                    $(tr).appendTo(thead);
                    $(thead).appendTo(table);
                    
                    $controller.userstory_add_patients_to_details();
                    $controller.userstory_color_dots();
                    $controller.userstory_create_histogram();
                    $model.userstory_compute_fisher_ratios();
                    
                }
                
                this.userstory_create_histogram = function(){
                    
                    document.getElementById("parameter_mean_histograms").innerHTML="";
                    
                    var margin = {top: 20, right: 20, bottom: 30, left: 40},
                            width = 20060 - margin.left - margin.right,
                            height = 400 - margin.top - margin.bottom;
                    
                    var x0 = d3.scale.ordinal()
                        .rangeRoundBands([0, width], .1);
                
                    var x1 = d3.scale.ordinal();
                    
                    var y = d3.scale.linear()
                            .range([height, 0]);
                    var color = d3.scale.ordinal()
                        .range(["#A9F5A9"]);
                
                    var xAxis = d3.svg.axis()
                        .scale(x0)
                        .orient("bottom");
                
                    var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .tickFormat(d3.format(".2s"));
                    
                    var svg = d3.select("#parameter_mean_histograms").append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                
                    data=[{"parameter":"a","group1":"10","group2":"20"},{"parameter":"b","group1":"30","group2":"20"},{"parameter":"c","group1":"10","group2":"50"},{"parameter":"d","group1":"15","group2":"23"}];
                    fisher_ratios = $model.userstory_compute_fisher_ratios();
                    var fisher_ratios_unsorted = fisher_ratios.slice(0);
                    compare_values = function(a,b){
                        return b-a;
                    }
                    fisher_ratios.sort(compare_values);
                    
                    data = [];
                    var current_item = {};
                    for (var i=0;i<$model.n_features;i++){
                        current_item = {};
                        for (var k=0;k<$model.n_features;k++){
                            if (fisher_ratios_unsorted[k]==fisher_ratios[i]){
                                current_item["parameter"]=$model.patients[0].RPPA[k].ID;
                            }
                        }
                        current_item["value"]=fisher_ratios[i];
                        data.push(current_item);
                    }
                    
                    var groupNames = d3.keys(data[0]).filter(function(key) { return key !== "parameter"; });
                    
                    console.log(groupNames);
                    
                    data.forEach(function(d) {
                        d.groups = groupNames.map(function(name) { return {name: name, value: +d[name]}; });
                    });
                    
                    
                    x0.domain(data.map(function(d) { return d.parameter; }));
                    x1.domain(groupNames).rangeRoundBands([0, x0.rangeBand()]);
                    y.domain([0, d3.max(data, function(d) { return d3.max(d.groups, function(d) { return d.value; }); })]);
                    
                    svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                    svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("fisher ratio");

                    var state = svg.selectAll(".state")
                        .data(data)
                        .enter().append("g")
                        .attr("class", "g")
                        .attr("transform", function(d) { return "translate(" + x0(d.parameter) + ",0)"; });

                    state.selectAll("rect")
                        .data(function(d) { return d.groups; })
                        .enter().append("rect")
                        .attr("width", x1.rangeBand())
                        .attr("x", function(d) { return x1(d.name); })
                        .attr("y", function(d) { return y(d.value); })
                        .attr("height", function(d) { return height - y(d.value); })
                        .style("fill", function(d) { return color(d.name); });

                    var legend = svg.selectAll(".legend")
                        .data(groupNames.slice().reverse())
                        .enter().append("g")
                        .attr("class", "legend")
                        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
                
               
                    legend.append("rect")
                        .attr("x", width - 18)
                        .attr("width", 18)
                        .attr("height", 18)
                        .style("fill", color);

                    legend.append("text")
                        .attr("x", width - 24)
                        .attr("y", 9)
                        .attr("dy", ".35em")
                        .style("text-anchor", "end")
                        .text(function(d) { return d; });     
                
                }
                
                this.userstory_2_color_dots = function(){
                    for (var i=0;i<$model.n_patients;i++){
                            if ($model.patients[i].clinical["tumor type"]=="1"){
                                $visualization.dots[i].material.color = new THREE.Color( 0x2EFE2E );
                            }
                            else if ($model.patients[i].clinical["tumor type"]=="2") {
                                $visualization.dots[i].material.color = new THREE.Color( 0xF3F781);
                            }
                            else{
                                $visualization.dots[i].material.color = new THREE.Color( 0xFF0000);
                            }
                        }
                }
                
            }
            
            $(function(){
                
                $visualization = new Visualization();
                $controller = new Controller();
                $model = new Model();
                $controller.add_mouse_listener();
                setInterval(function(){ $visualization.render() }, 5);
                
            });
                
        </script>
    </head>
    <body>
       
        <div class="container-fluid">
            
            <div class="row">
                <div class="col-md-1">
                <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" id="menu1" data-toggle="dropdown">Select Dataset
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="acc">acc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="blca">blca</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="brca">brca</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="cesc">cesc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="chol">chol</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="cntl">cntl</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="coad">coad</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="dlbc">dlbc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="esca">esca</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="fppp">fppp</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="gbm">gbm</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="hnsc">hnsc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="kich">kich</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="kirp">kirp</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="laml">laml</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lcml">lcml</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lgg">lgg</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lihc">lihc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lnnh">lnnh</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="luad">luad</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="lusc">lusc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="meso">meso</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="ov">ov</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="paad">paad</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="pcpg">pcpg</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="prad">prad</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="read">read</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="sarc">sarc</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="skcm">skcm</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="stad">stad</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="tgct">tgct</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="thym">thym</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="ucec">ucec</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="ucs">ucs</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="uvm">uvm</a></li>
                    <li role="presentation"><a class="dataset_selection" role="menuitem" tabindex="-1" href="#" id="brca2">brca2</a></li>
                </ul>
                </div>
                </div>
                <div class="col-md-4">
                <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" id="menu2" data-toggle="dropdown">Userstories
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="menu2">
                    <li role="presentation"><a class="userstory_selection" role="menuitem" tabindex="-1" href="#" id="userstory_lcsc">smoking status in lusc</a></li>
                    <li role="presentation"><a class="userstory_selection" role="menuitem" tabindex="-1" href="#" id="userstory_brca">risk classification of brca</a></li>
                </ul>
                </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-7" id="visuals"></div>
                <div class="col-md-5" id="parameter_controls">
                    <div class="row" style="margin-top:-20px"></div>
                    <div class="col-md-12" id="clinical_controls"></div>
                    <div class="row"></div>
                    <div class="col-md-12" id="rppa_controls"></div>
                </div>
                
            </div>
            
            <div class="row">
                <div class="col-md-3" id="group1"></div>
                <div class="col-md-3" id="group2"></div>
                <div class="col-md-3" id="group3"></div>
                <div class="col-md-3" id="group4"></div>
            </div>
            
            <div class="row">
                <div class="col-md-3" id="male_female_distribution"></div>
                <div class="col-md-5" id="age_distribution"></div>
                <div class="col-md-4" id="tumor_type_distribution"></div>
            </div>
            
            <div class="row">
                <div class="col-md-12" id="rppa_distribution"></div>
            </div>
            
            <div class="checkbox">
                <label><input type="checkbox" onchange="$model.tsne()" id="tsne_checkbox">t-SNE</label>
            </div>

    </div> 
        
   
    </body>
</html>
